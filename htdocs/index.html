<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>mod-mapcache demo service</title>
    <style type="text/css">
    #map {
    width: 100%;
    height: 100%;
    border: 1px solid black;
    }
    </style>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script type="text/javascript">
function QuadTree(tx, ty, zoom) {
    var tname = '';
    var i, j, mask, digit;
    var zero = '0'.charCodeAt(0);

    if (ty < 0) ty = 2 - ty;
    ty = (Math.pow(2,zoom) - 1) - ty;

    for (i=zoom, j=0; i>0; i--, j++) {
        digit = 0;
        mask = 1 << (i-1);
        if (tx & mask) digit += 1;
        if (ty & mask) digit += 2;
        tname += String.fromCharCode(zero + digit);
    }
    return tname;
}
    function WGSQuadTree(tx, ty, zoom) {
        var tname = '';
        var i, n;
        var zero = '0'.charCodeAt(0);

        ty = (Math.pow(2,zoom-1) - 1) - ty;

        for (i=zoom; i>0; i--) {
            if (i == 1)
                n = Math.floor(tx/2)*4 + tx%2 + (ty%2)*2;
            else
                n = (ty%2)*2 + tx%2;
            if (n<0 || n>9)
                return '';
            tname = String.fromCharCode(zero + n) + tname;
            tx = Math.floor(tx/2);
            ty = Math.floor(ty/2);
        }
        return tname;
    }
function get_ve_url (bounds) {
    var xoriginShift, yoriginShift, id;
    if (this.sphericalMercator) {
        xoriginShift = 2 * Math.PI * 6378137.0 / 2.0; // meters
        yoriginShift = xoriginShift;
    }
    else {
        xoriginShift = 180.0;
        yoriginShift = 90;
    }

    var res = this.map.getResolution();
    var x = Math.floor(Math.ceil(((bounds.left + bounds.right)/2.0 + xoriginShift) / res / this.tileSize.w) - 1);
    var y = Math.floor(Math.ceil(((bounds.top + bounds.bottom)/2.0 + yoriginShift) / res / this.tileSize.h) - 1);
    var z = this.map.getZoom();
    if (this.sphericalMercator) {
        id = QuadTree(x, y, z);
    }
    else {
        id = WGSQuadTree(x, y, z);
    }
    var path = '?LAYER=' + this.options.layername + '&tile=' + id;
    var url = this.url;
    if (url instanceof Array) {
        url = this.selectUrl(path, url);
    }
    return url + path;
}

var map;
function init(){
    map = new OpenLayers.Map( 'map', {
        displayProjection: new OpenLayers.Projection("EPSG:4326")
    } );
    var test_WGS84_ve_layer = new OpenLayers.Layer.TMS( "test-WGS84-VE",
        "http://commonlandunit.com:8000/mapcache/ve",
        { layername: 'test@WGS84',
          getURL: get_ve_url,
          gutter:0,buffer:0,isBaseLayer:true,transitionEffect:'resize',
          resolutions:[0.70312500000000000000,0.35156250000000000000,0.17578125000000000000,0.08789062500000000000,0.04394531250000000000,0.02197265625000000000,0.01098632812500000000,0.00549316406250000000,0.00274658203125000000,0.00137329101562500000,0.00068664550781250000,0.00034332275390625000,0.00017166137695312500,0.00008583068847656250,0.00004291534423828120,0.00002145767211914060,0.00001072883605957030,0.00000536441802978516],
          units:"dd",
          maxExtent: new OpenLayers.Bounds(-180.000000,-90.000000,180.000000,90.000000),
          projection: new OpenLayers.Projection("EPSG:4326".toUpperCase()),
          sphericalMercator: false
        }
    );
    map.addLayer(test_WGS84_ve_layer)

    var test_g_ve_layer = new OpenLayers.Layer.TMS( "test-g-VE",
        "http://commonlandunit.com:8000/mapcache/ve",
        { layername: 'test@g',
          getURL: get_ve_url,
          gutter:0,buffer:0,isBaseLayer:true,transitionEffect:'resize',
          resolutions:[156543.03392804099712520838,78271.51696402048401068896,39135.75848201022745342925,19567.87924100512100267224,9783.93962050256050133612,4891.96981025128025066806,2445.98490512564012533403,1222.99245256282006266702,611.49622628141003133351,305.74811314070478829308,152.87405657035250783338,76.43702828517623970583,38.21851414258812695834,19.10925707129405992646,9.55462853564703173959,4.77731426782351586979,2.38865713391175793490,1.19432856695587897633,0.59716428347793950593],
          units:"m",
          maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
          projection: new OpenLayers.Projection("EPSG:900913".toUpperCase()),
          sphericalMercator: true
        }
    );
    map.addLayer(test_g_ve_layer)

    var clu_WGS84_ve_layer = new OpenLayers.Layer.TMS( "clu-WGS84-VE",
        "http://commonlandunit.com:8000/mapcache/ve",
        { layername: 'clu@WGS84',
          getURL: get_ve_url,
          gutter:0,buffer:0,isBaseLayer:true,transitionEffect:'resize',
          resolutions:[0.70312500000000000000,0.35156250000000000000,0.17578125000000000000,0.08789062500000000000,0.04394531250000000000,0.02197265625000000000,0.01098632812500000000,0.00549316406250000000,0.00274658203125000000,0.00137329101562500000,0.00068664550781250000,0.00034332275390625000,0.00017166137695312500,0.00008583068847656250,0.00004291534423828120,0.00002145767211914060,0.00001072883605957030,0.00000536441802978516],
          units:"dd",
          maxExtent: new OpenLayers.Bounds(-180.000000,-90.000000,180.000000,90.000000),
          projection: new OpenLayers.Projection("EPSG:4326".toUpperCase()),
          sphericalMercator: false
        }
    );
    map.addLayer(clu_WGS84_ve_layer)

    var clu_g_ve_layer = new OpenLayers.Layer.TMS( "clu-g-VE",
        "http://commonlandunit.com:8000/mapcache/ve",
        { layername: 'clu@g',
          getURL: get_ve_url,
          gutter:0,buffer:0,isBaseLayer:true,transitionEffect:'resize',
          resolutions:[156543.03392804099712520838,78271.51696402048401068896,39135.75848201022745342925,19567.87924100512100267224,9783.93962050256050133612,4891.96981025128025066806,2445.98490512564012533403,1222.99245256282006266702,611.49622628141003133351,305.74811314070478829308,152.87405657035250783338,76.43702828517623970583,38.21851414258812695834,19.10925707129405992646,9.55462853564703173959,4.77731426782351586979,2.38865713391175793490,1.19432856695587897633,0.59716428347793950593],
          units:"m",
          maxExtent: new OpenLayers.Bounds(-20037508.342789,-20037508.342789,20037508.342789,20037508.342789),
          projection: new OpenLayers.Projection("EPSG:900913".toUpperCase()),
          sphericalMercator: true
        }
    );
    map.addLayer(clu_g_ve_layer)

    if(!map.getCenter())
     map.zoomToMaxExtent();
    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.addControl(new OpenLayers.Control.MousePosition());
}
    </script>
  </head>

<body onload="init()">
    <div id="map">
    </div>
</body>
</html>
